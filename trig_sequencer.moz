@OnLoad
  ShowLayout 1
  SetMetroSwing 0

  SetMetroPPQN 384

  LabelKnobs { }

  if Unassigned notes
    for knob = 0 to 7
      noteVal = 64
      Call @MySetNoteKnob
    endfor
  else
    for knob = 0 to 7
      noteVal = notes[knob]
      Call @MySetNoteKnob
    endfor    
  endif

  if Unassigned maxStep
    LabelKnob 10, {Length:8} 
    SetKnobValue 10, 127
    maxStep = 8
  else
    LabelKnob 10, {Length:}, maxStep
    SetKnobValue 10, (maxStep - 2) / 6 * 127
  endif

  if Unassigned mutateProb
    mutateProb = 0
  endif   
  LabelKnob 14, {Mutate}
  SetKnobValue 14, mutateProb 
  
  if Unassigned gateLength
    gateLength = 1
  endif   
  LabelKnob 15, {Gate}
  SetKnobValue 15, (gateLength - 1)/500 * 127

  lastStep = maxStep - 1
  newStep = -1

  if Unassigned trigs
    for knob = 11 to 13
      LabelKnob knob, {-}
      SetKnobValue knob, 0
      trigs[knob-11] = 0
    endfor
  else
    for knob = 11 to 13
      trigVal = trigs[knob-11]
      SetKnobValue knob, trigVal / 16 * 127
      if trigVal = 0
        LabelKnob knob, {-}
      else
        LabelKnob knob, {1/}, trigVal
      endif
    endfor
  endif
  
  Call @MySetAllPulses

  LabelKnob 8, { }
  SetKnobValue 8, 0
  LabelKnob 9, { }
  SetKnobValue 9, 0
  LabelKnob 16, { }
  SetKnobValue 16, 0
  LabelKnob 17, { }
  SetKnobValue 17, 0
  LabelKnob 18, { }
  SetKnobValue 18, 0
  LabelKnob 19, { }
  SetKnobValue 19, 0
  LabelKnob 20, { }
  SetKnobValue 20, 0
  LabelKnob 21, { }
  SetKnobValue 21, 0

@End

@OnKnobChange
  knob = LastKnob
  knobVal = (GetKnobValue knob)

  if knob >= 0 and knob <= 7
    noteVal = Round(knobVal)
    Call @MySetNoteKnob
  elseif knob = 8 or knob = 9 or knob = 16 or knob = 17 or knob = 18 or knob = 19 or knob = 20 or knob = 21
    SetKnobValue knob, 0
  elseif knob = 10
    maxStep = Round(knobVal / 127 * 6) + 2
    LabelKnob knob, {Length:}, maxStep
  elseif knob >= 11 and knob <= 13
    trigVal = Round(knobVal / 127 * 16)
    trigs[knob-11] = trigVal
    if trigVal = 0
      LabelKnob knob, {-}
    else
      LabelKnob knob, {1/}, trigVal
    endif
    Call @MySetAllPulses    
  elseif knob = 14
    mutateProb = knobVal
  elseif knob = 15
    gateLength = knobVal / 127 * 500 + 1
  endif
@End

@MyAddPulse
  if pulse < 1000
    Inc pulses1[pulse]
  else
    Inc pulses2[pulse-1000]
  endif
@End

@MySetAllPulses
  for i = 0 to 1000
    pulses1[i] = 0
    pulses2[i] = 0
  endfor

  for i = 0 to 2
    v = trigs[i]
    if v=1
      pulse = 0
      call @MyAddPulse
    elseif v=2
      pulse = 0
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
    elseif v=3
      pulse = 0
      call @MyAddPulse
      pulse = 512
      call @MyAddPulse
      pulse = 1024
      call @MyAddPulse
    elseif v=4
      pulse = 0
      call @MyAddPulse
      pulse = 384
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
      pulse = 1152
      call @MyAddPulse
    elseif v=5
      pulse = 0
      call @MyAddPulse
      pulse = 307
      call @MyAddPulse
      pulse = 614
      call @MyAddPulse
      pulse = 922
      call @MyAddPulse
      pulse = 1229
      call @MyAddPulse
    elseif v=6
      pulse = 0
      call @MyAddPulse
      pulse = 256
      call @MyAddPulse
      pulse = 512
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
      pulse = 1024
      call @MyAddPulse
      pulse = 1280
      call @MyAddPulse
    elseif v=7
      pulse = 0
      call @MyAddPulse
      pulse = 219
      call @MyAddPulse
      pulse = 439
      call @MyAddPulse
      pulse = 658
      call @MyAddPulse
      pulse = 878
      call @MyAddPulse
      pulse = 1097
      call @MyAddPulse
      pulse = 1317
      call @MyAddPulse
    elseif v=8
      pulse = 0
      call @MyAddPulse
      pulse = 192
      call @MyAddPulse
      pulse = 384
      call @MyAddPulse
      pulse = 576
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
      pulse = 960
      call @MyAddPulse
      pulse = 1152
      call @MyAddPulse
      pulse = 1344
      call @MyAddPulse
    elseif v=9
      pulse = 0
      call @MyAddPulse
      pulse = 171
      call @MyAddPulse
      pulse = 341
      call @MyAddPulse
      pulse = 512
      call @MyAddPulse
      pulse = 683
      call @MyAddPulse
      pulse = 853
      call @MyAddPulse
      pulse = 1024
      call @MyAddPulse
      pulse = 1195
      call @MyAddPulse
      pulse = 1365
      call @MyAddPulse
    elseif v=10
      pulse = 0
      call @MyAddPulse
      pulse = 154
      call @MyAddPulse
      pulse = 307
      call @MyAddPulse
      pulse = 461
      call @MyAddPulse
      pulse = 614
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
      pulse = 922
      call @MyAddPulse
      pulse = 1075
      call @MyAddPulse
      pulse = 1229
      call @MyAddPulse
      pulse = 1382
      call @MyAddPulse
    elseif v=11
      pulse = 0
      call @MyAddPulse
      pulse = 140
      call @MyAddPulse
      pulse = 279
      call @MyAddPulse
      pulse = 419
      call @MyAddPulse
      pulse = 559
      call @MyAddPulse
      pulse = 698
      call @MyAddPulse
      pulse = 838
      call @MyAddPulse
      pulse = 977
      call @MyAddPulse
      pulse = 1117
      call @MyAddPulse
      pulse = 1257
      call @MyAddPulse
      pulse = 1396
      call @MyAddPulse
    elseif v=12
      pulse = 0
      call @MyAddPulse
      pulse = 128
      call @MyAddPulse
      pulse = 256
      call @MyAddPulse
      pulse = 384
      call @MyAddPulse
      pulse = 512
      call @MyAddPulse
      pulse = 640
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
      pulse = 896
      call @MyAddPulse
      pulse = 1024
      call @MyAddPulse
      pulse = 1152
      call @MyAddPulse
      pulse = 1280
      call @MyAddPulse
      pulse = 1408
      call @MyAddPulse
    elseif v=13
      pulse = 0
      call @MyAddPulse
      pulse = 118
      call @MyAddPulse
      pulse = 236
      call @MyAddPulse
      pulse = 354
      call @MyAddPulse
      pulse = 473
      call @MyAddPulse
      pulse = 591
      call @MyAddPulse
      pulse = 709
      call @MyAddPulse
      pulse = 827
      call @MyAddPulse
      pulse = 945
      call @MyAddPulse
      pulse = 1063
      call @MyAddPulse
      pulse = 1182
      call @MyAddPulse
      pulse = 1300
      call @MyAddPulse
      pulse = 1418
      call @MyAddPulse
    elseif v=14
      pulse = 0
      call @MyAddPulse
      pulse = 110
      call @MyAddPulse
      pulse = 219
      call @MyAddPulse
      pulse = 329
      call @MyAddPulse
      pulse = 439
      call @MyAddPulse
      pulse = 549
      call @MyAddPulse
      pulse = 658
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
      pulse = 878
      call @MyAddPulse
      pulse = 987
      call @MyAddPulse
      pulse = 1097
      call @MyAddPulse
      pulse = 1207
      call @MyAddPulse
      pulse = 1317
      call @MyAddPulse
      pulse = 1426
      call @MyAddPulse
    elseif v=15
      pulse = 0
      call @MyAddPulse
      pulse = 102
      call @MyAddPulse
      pulse = 205
      call @MyAddPulse
      pulse = 307
      call @MyAddPulse
      pulse = 410
      call @MyAddPulse
      pulse = 512
      call @MyAddPulse
      pulse = 614
      call @MyAddPulse
      pulse = 717
      call @MyAddPulse
      pulse = 819
      call @MyAddPulse
      pulse = 922
      call @MyAddPulse
      pulse = 1024
      call @MyAddPulse
      pulse = 1126
      call @MyAddPulse
      pulse = 1229
      call @MyAddPulse
      pulse = 1331
      call @MyAddPulse
      pulse = 1434
      call @MyAddPulse
    elseif v=16
      pulse = 0
      call @MyAddPulse
      pulse = 96
      call @MyAddPulse
      pulse = 192
      call @MyAddPulse
      pulse = 288
      call @MyAddPulse
      pulse = 384
      call @MyAddPulse
      pulse = 480
      call @MyAddPulse
      pulse = 576
      call @MyAddPulse
      pulse = 672
      call @MyAddPulse
      pulse = 768
      call @MyAddPulse
      pulse = 864
      call @MyAddPulse
      pulse = 960
      call @MyAddPulse
      pulse = 1056
      call @MyAddPulse
      pulse = 1152
      call @MyAddPulse
      pulse = 1248
      call @MyAddPulse
      pulse = 1344
      call @MyAddPulse
      pulse = 1440
      call @MyAddPulse
    endif
  endfor
@End

@OnMetroPulse
  addStep = 0
  p = CurrentMetroPulse
  if p < 1000
    addStep = pulses1[p]
  else
    addStep = pulses2[p-1000]
  endif

  if addStep > 0
    if mutateProb > Random 0, 127
      newStep = Random 0, maxStep-1
    else 
      newStep = (lastStep + addStep) % maxStep
    endif
    Call @MySetNewStep
  endif
@End

@MySetNoteKnob
  LabelKnob knob, {‚ö´Ô∏è}, (NoteName noteVal, YES)
  notes[knob] = noteVal
@End

@MySetNewStep
  note = notes[newStep] 
  SendMIDINoteOn 0, note, 100
  SendMIDINoteOff 0, note, 0, gateLength

  if newStep <> lastStep
    LabelKnob newStep, {üî¥}, (NoteName note, YES)
    note = notes[lastStep]
    LabelKnob lastStep, {‚ö´Ô∏è}, (NoteName note, YES)
  
    lastStep = newStep
  endif
@End

@OnShiftDown
  recStep = 0
@End 

@OnMidiNoteOn
  if ShiftPressed 
    noteVal = MIDINote
    knob = recStep
    SetKnobValue knob, noteVal 
    call @MySetNoteKnob
    recStep = (recStep + 1) % 8
  endif 
@End
